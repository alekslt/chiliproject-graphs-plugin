<!doctype>
<html>
<head>

<%= stylesheet_link_tag('rickshaw/rickshaw.min.css', :plugin => 'chiliproject-graphs-plugin') %>
<%= javascript_include_tag('rickshaw/vendor/d3.min.js', :plugin => 'chiliproject-graphs-plugin') %>
<%= javascript_include_tag('rickshaw/vendor/d3.layout.min.js', :plugin => 'chiliproject-graphs-plugin') %>
<%= javascript_include_tag('rickshaw/rickshaw.min.js', :plugin => 'chiliproject-graphs-plugin') %>

<style>

#chart_container {
        display: inline-block;
        font-family: Arial, Helvetica, sans-serif;
}
#chart {
        float: left;
}
#legend {
        float: left;
        margin-left: 15px;
}
#offset_form {
        float: left;
        margin: 2em 0 0 15px;
        font-size: 13px;
}
#y_axis {
        float: left;
        width: 40px;
}
</style>
</head>

<body>
<div id="chart_container">
        <div id="y_axis"></div>
        <div id="chart"></div>
        <form id="offset_form" class="toggler">
                <input type="radio" name="offset" id="lines" value="lines">
                <label class="lines" for="lines">lines</label><br>
                <input type="radio" name="offset" id="stack" value="zero" checked>
                <label class="stack" for="stack">stack</label>
        </form>
</div>
<div id="legend"></div>
<script>
        var palette = new Rickshaw.Color.Palette();

var graph = new Rickshaw.Graph( {
        element: document.querySelector("#chart"),
        interpolation: 'linear',
        width: 800,
        height: 300,

        series: [

        <% @sorted_status.each do |status_id|
                next if status_id == -1

                status_instance = IssueStatus.find_by_id(status_id)
                status_text = "Unknown: #{status_id}"
                status_text = status_instance.name unless status_instance.nil?

                %>
                {
                        name: "<%= status_text %>",    
                        data: [ 
                <%

                date_and_count = @issues_by_status_date_sum[status_id]

                date_and_count.keys.sort.each do |changed_on|
                        num = date_and_count[changed_on]
                        
                        if @scope_start_date.nil? || @scope_start_date <= changed_on
                                day = changed_on.to_time.to_i
                                %>
                                { x: <%= day %>, y: <%= num %> },
                                <%
                        end  
                end
            %>
                        ],
                        color: palette.color()
                },
            <%
        end %>
        ]
} );

var x_axis = new Rickshaw.Graph.Axis.Time( { 
        graph: graph,
        pixelsPerTick: 50
} );

var y_axis = new Rickshaw.Graph.Axis.Y( {
        graph: graph,
        orientation: 'left',
        tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
        element: document.getElementById('y_axis'),
} );

var legend = new Rickshaw.Graph.Legend( {
        element: document.querySelector('#legend'),
        graph: graph
} );

var offsetForm = document.getElementById('offset_form');

offsetForm.addEventListener('change', function(e) {
        var offsetMode = e.target.value;

        if (offsetMode == 'lines') {
                graph.setRenderer('line');
                graph.offset = 'zero';
        } else {
                graph.setRenderer('stack');
                graph.offset = offsetMode;
        }       
        graph.render();

}, false);

var hoverDetail = new Rickshaw.Graph.HoverDetail( {
    graph: graph
} );

graph.render();

</script>

</body>
</html>